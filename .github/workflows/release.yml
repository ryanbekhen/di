name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.25"

      - name: Generate changelog
        id: changelog
        run: |
          git fetch --prune --unshallow || true

          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          CUR_TAG=${GITHUB_REF_NAME}

          if [ -n "$PREV_TAG" ]; then
            RANGE="$PREV_TAG..$CUR_TAG"
          else
            RANGE="$CUR_TAG"
          fi

          echo "Generating changelog for range: $RANGE"

          make_section() {
            local title=$1
            local pattern=$2
            local logs
            logs=$(git log $RANGE --pretty=format:'- %s' | grep -i "$pattern" || true)
            if [ -n "$logs" ]; then
              echo "### $title"
              echo "$logs"
              echo ""
            fi
          }

          echo "## Changes in $CUR_TAG" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          make_section "Features" '^feat'
          make_section "Bug Fixes" '^fix'
          make_section "Documentation" '^docs'
          make_section "Chores" '^chore'
          make_section "Refactors" '^refactor'
          make_section "Tests" '^test'

          OTHER_LOGS=$(git log $RANGE --pretty=format:'- %s' | grep -viE '^(feat|fix|docs|chore|refactor|test):' || true)
          if [ -n "$OTHER_LOGS" ]; then
            echo "### Other" >> CHANGELOG.md
            echo "$OTHER_LOGS" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
          fi

          echo "----- GENERATED CHANGELOG -----"
          cat CHANGELOG.md
          echo "-------------------------------"

          echo "release_body<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.release_body }}